<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Validaci√≥n de Ubicaci√≥n</title>
  <style>
    body{
      font-family: Arial, sans-serif;
      text-align:center;
      padding:30px;
    }
    button{
      padding:18px 28px;
      font-size:18px;
      margin-top:20px;
    }
  </style>
</head>

<body>

  <h2>Validando ubicaci√≥n‚Ä¶</h2>
  <button onclick="capturar()">Activar ubicaci√≥n</button>

  <div id="resultado" style="margin-top:25px;"></div>

<script>

function obtenerParametro(nombre){
  const urlParams = new URLSearchParams(window.location.search);
  return urlParams.get(nombre);
}

function calcularDistancia(lat1, lon1, lat2, lon2){

  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;

  const a =
    Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(lat1 * Math.PI / 180) *
    Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon/2) * Math.sin(dLon/2);

  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

function capturar(){

  navigator.geolocation.getCurrentPosition(function(pos){

    const latUsuario = pos.coords.latitude;
    const lngUsuario = pos.coords.longitude;

    const latCentro = parseFloat(obtenerParametro("latCentro"));
    const lngCentro = parseFloat(obtenerParametro("lngCentro"));
    const radio = parseFloat(obtenerParametro("radio"));
    const curso = obtenerParametro("curso");
    const activo = obtenerParametro("activo");

    if(activo !== "SI"){
      document.getElementById("resultado").innerHTML =
        "<h3>‚ö†Ô∏è Curso no activo.</h3>";
      return;
    }

    const distancia = calcularDistancia(latUsuario,lngUsuario,latCentro,lngCentro);

    if(distancia <= radio){

      const formBase = "https://docs.google.com/forms/d/e/1FAIpQLScjDqB6ZXNSSQdTSZKcKnie1KO5WX8SU076Un-SoIUBBNwZNg/viewform";
      const entryCurso = "entry.1574913457";

      const formURL =
        formBase +
        "?usp=pp_url&" +
        entryCurso + "=" + encodeURIComponent(curso);

      document.getElementById("resultado").innerHTML =
        "<h3>üìç Ubicaci√≥n verificada</h3>" +
        "<p>Redirigiendo al examen‚Ä¶</p>";

      setTimeout(function(){
        window.location.href = formURL;
      },800);

    } else {

      document.getElementById("resultado").innerHTML =
        "<h3>‚ùå Usted no se encuentra dentro del per√≠metro autorizado.</h3>";
    }

  }, function(){
    alert("Debe permitir la ubicaci√≥n.");
  });

}

</script>

</body>
</html>
